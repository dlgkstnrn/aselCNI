<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aselcni.UjmOutitemMapper">

	<!-- 소문자 사용 -->
	
	
	
	
	<select id="ujmTotalOutitemCnt" resultType="int">
		<![CDATA[
		SELECT COUNT(*)
		FROM TB_OUTITEM ou
    		INNER JOIN TB_CUSTMST c ON ou.cust_cd = c.cust_cd
    		INNER JOIN TB_ORDER ord ON ou.order_no = ord.order_no
    		INNER JOIN TB_USERMST u ON ou.OUTITEM_EMP_ID  = u.user_id
		WHERE ou.outitem_delete_chk = 0;
		]]> 



	</select>
	
	<select id="ujmListOutitemAll" parameterType="UjmOutitem" resultType="UjmOutitem">
		<![CDATA[
			SELECT 
			    sub.rn,
			    sub.outitem_no,
			    sub.seq_no,
			    sub.cust_cd,
			    sub.cust_nm,
			    sub.order_no,
			    sub.order_dt,
			    sub.order_end_dt,
			    sub.order_status_chk,
			    sub.remark,
	            sub.outitem_dt,
	            sub.user_nm,
	            
			    STUFF((
			        SELECT ', ' + itemmst.item_nm + ' (' + CAST(oi.qty AS VARCHAR(10)) + '개)'
			        FROM TB_OUTITEM_ITEM oi
			        JOIN TB_ITEMMST itemmst ON oi.item_cd = itemmst.item_cd
			        WHERE sub.outitem_no = oi.outitem_no AND sub.order_no = oi.order_no
			        FOR XML PATH('')), 1, 2, '') AS items
	
			FROM (
		    	SELECT 
			        ROW_NUMBER() OVER (ORDER BY CAST
			        	(SUBSTRING(ou.outitem_no, PATINDEX('%[0-9]%', ou.outitem_no), 
			        							  LEN(ou.outitem_no)) AS BIGINT) DESC) AS rn, 
			        							  
			        ou.outitem_no,
			        ou.cust_cd, 
			        ou.seq_no,
			        c.cust_nm, 
			        ou.order_no, 
			        ord.order_dt, 
			        ord.order_end_dt, 
			        ord.order_status_chk, 
			        u.user_nm,
			        ou.remark,
	        		ou.outitem_dt
	        		
		    	FROM 
			        TB_OUTITEM ou
			        INNER JOIN TB_CUSTMST c ON ou.cust_cd = c.cust_cd
			        INNER JOIN TB_ORDER ord ON ou.order_no = ord.order_no
			        INNER JOIN TB_USERMST u ON ou.OUTITEM_EMP_ID  = u.user_id
		    	WHERE 
		        	ou.outitem_delete_chk = 0
			) AS sub
			WHERE 
		    	sub.rn >= ${start} AND sub.rn <= ${end}
		]]> 
	</select>
	
	<select id="outitemNoCnt" parameterType="String" resultType="int">
		<![CDATA[
			SELECT COUNT(*) 
			FROM tb_outitem
			WHERE outitem_no LIKE CONCAT('%', #{outitem_no}, '%')
		]]> 
	</select>
	
	<select id="ujmGetSeqNo" parameterType="String" resultType="int">
		<![CDATA[
			SELECT COUNT(outitem_no) 
			FROM tb_outitem
			WHERE order_no = #{order_no};
		]]> 
	</select>
	


	<insert id="ujmInsertOutitem" parameterType="UjmOutitem">
		<![CDATA[
			insert into tb_outitem (outitem_no, seq_no, order_no, outitem_dt, cust_cd,
				cust_emp, remark, outitem_emp_id, outitem_delete_chk)
				
			values ( #{outitem_no}, #{seq_no}, #{order_no}, #{outitem_dt}, #{cust_cd},
				#{cust_emp}, #{remark}, #{outitem_emp_id}, 0)
		]]> 
	</insert>
	
	
	<insert id="ujmInsertOutitemItem" parameterType="UjmOutitemItem">
		<![CDATA[
			insert into tb_outitem_item (outitem_no, order_no, item_cd, qty)
				
			values ( #{outitem_no}, #{order_no}, #{item_cd}, #{qty} )
		]]> 
	</insert>
	
	<select id="ujmOutitemItemCnt" parameterType="UjmOutitemItem" resultType="int">
		<![CDATA[
			SELECT COUNT(*) 
			FROM tb_outitem_item
			WHERE outitem_no = #{outitem_no}
			AND order_no = #{order_no}
		]]> 
	</select>
	
	
	
	
	
	
	
</mapper>